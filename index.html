<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI App Architect | Lovable Clone</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Inter:wght@300;400;600&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #0d0d0d; color: #e5e7eb; overflow: hidden; }
        .code-font { font-family: 'Fira Code', monospace; }
        
        #app-loader { transition: opacity 0.5s ease; }
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
        
        iframe { background: white; border-radius: 4px; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }

        .glass { background: rgba(23, 23, 23, 0.8); backdrop-filter: blur(12px); }
        
        @media (max-width: 1024px) {
            .view-panel { display: none; }
            .view-panel.active { display: flex; }
        }
    </style>
</head>
<body class="h-[100dvh] flex flex-col">

    <div id="app-loader" class="fixed inset-0 z-[100] flex items-center justify-center bg-[#0d0d0d]">
        <div class="text-center">
            <div class="inline-block w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-4 font-semibold tracking-widest text-blue-400">ARCHITECT INITIALIZING</p>
        </div>
    </div>

    <header class="h-14 border-b border-white/10 flex items-center justify-between px-4 glass z-40">
        <div class="flex items-center gap-2">
            <div class="w-6 h-6 bg-blue-600 rounded shadow-lg shadow-blue-900/20"></div>
            <span class="font-bold tracking-tight hidden sm:inline-block text-white">AppArchitect <span class="text-blue-500 text-xs">v1.0</span></span>
        </div>

        <nav class="flex lg:hidden gap-4 h-full">
            <button onclick="switchTab('chat')" id="tab-chat" class="px-2 h-full flex items-center text-sm tab-active">Chat</button>
            <button onclick="switchTab('preview')" id="tab-preview" class="px-2 h-full flex items-center text-sm">Preview</button>
            <button onclick="switchTab('code')" id="tab-code" class="px-2 h-full flex items-center text-sm">Code</button>
        </nav>

        <div class="flex items-center gap-3">
            <div class="flex items-center gap-1 bg-white/5 rounded-md px-2 py-1">
                <button onclick="navigateHistory(-1)" class="p-1 hover:text-blue-400 disabled:opacity-30" id="prev-btn" disabled>&larr;</button>
                <span id="version-label" class="text-[10px] text-white/50 px-1">V0</span>
                <button onclick="navigateHistory(1)" class="p-1 hover:text-blue-400 disabled:opacity-30" id="next-btn" disabled>&rarr;</button>
            </div>
            <button onclick="downloadCode()" class="p-2 bg-white/5 hover:bg-white/10 rounded-md transition-colors" title="Download HTML">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
            <button onclick="toggleSettings()" class="p-2 hover:bg-white/10 rounded-md transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" stroke-width="2" stroke-linecap="round"/></svg>
            </button>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        
        <section id="panel-chat" class="view-panel active flex-1 flex flex-col border-r border-white/10 bg-[#141414] relative lg:max-w-[500px] xl:max-w-[600px]">
            <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-6 custom-scrollbar">
                <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4 text-sm leading-relaxed">
                    <h3 class="font-bold text-blue-400 mb-2 underline">System Ready</h3>
                    Describe the application you want to build. I will generate the code and render it live on the right.
                </div>
            </div>

            <div class="p-4 bg-[#141414] border-t border-white/5">
                <form id="chat-form" class="relative group">
                    <textarea id="prompt-input" rows="1" placeholder="Describe your app..." 
                        class="w-full bg-[#1e1e1e] border border-white/10 rounded-xl px-4 py-3 pr-12 focus:outline-none focus:border-blue-500 transition-all resize-none max-h-32"></textarea>
                    <button type="submit" id="send-btn" class="absolute right-2 bottom-2.5 p-1.5 text-blue-500 hover:bg-blue-500 hover:text-white rounded-lg transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </button>
                </form>
                <div id="status-text" class="text-[10px] uppercase tracking-tighter text-white/30 mt-2 flex justify-between">
                    <span>Model: <span id="model-badge">Gemini Flash</span></span>
                    <span id="thinking-state" class="hidden animate-pulse">Constructing...</span>
                </div>
            </div>
        </section>

        <section id="panel-preview" class="view-panel flex-1 bg-[#0d0d0d] flex flex-col p-2 lg:flex">
            <div class="h-6 flex items-center gap-2 mb-1 px-2">
                <div class="flex gap-1">
                    <div class="w-2.5 h-2.5 rounded-full bg-red-500/50"></div>
                    <div class="w-2.5 h-2.5 rounded-full bg-yellow-500/50"></div>
                    <div class="w-2.5 h-2.5 rounded-full bg-green-500/50"></div>
                </div>
                <span class="text-[10px] text-white/30 uppercase font-bold tracking-widest">Live Renderer</span>
            </div>
            <div class="flex-1 relative bg-white rounded overflow-hidden">
                <iframe id="preview-frame" class="w-full h-full border-none" sandbox="allow-scripts allow-modals allow-forms allow-popups"></iframe>
            </div>
        </section>

        <section id="panel-code" class="view-panel flex-1 bg-[#1e1e1e] flex flex-col hidden lg:hidden">
            <div class="p-2 border-b border-white/10 flex justify-between items-center bg-[#141414]">
                <span class="text-xs font-mono text-white/50">index.html</span>
                <button onclick="copyCode()" class="text-[10px] bg-white/10 px-2 py-1 rounded hover:bg-white/20">COPY</button>
            </div>
            <textarea id="code-editor" readonly class="flex-1 bg-transparent p-4 font-mono text-sm text-blue-200 outline-none resize-none"></textarea>
        </section>
    </main>

    <div id="settings-modal" class="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-[#141414] w-full max-w-md border border-white/10 rounded-2xl shadow-2xl overflow-hidden">
            <div class="p-6 border-b border-white/10 flex justify-between items-center">
                <h2 class="font-bold">Architect Settings</h2>
                <button onclick="toggleSettings()" class="text-white/50 hover:text-white">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs uppercase text-white/50 font-bold mb-1">OpenRouter API Key</label>
                    <input type="password" id="api-key" placeholder="sk-or-..." class="w-full bg-[#1e1e1e] border border-white/10 rounded-lg p-2 focus:border-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs uppercase text-white/50 font-bold mb-1">AI Model</label>
                    <select id="model-select" class="w-full bg-[#1e1e1e] border border-white/10 rounded-lg p-2 focus:border-blue-500 outline-none">
                        <option value="google/gemini-2.0-flash-exp:free">Gemini 2.0 Flash (Fast)</option>
                        <option value="deepseek/deepseek-r1:free">DeepSeek R1 (Reasoning)</option>
                        <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet</option>
                    </select>
                </div>
                <div class="pt-4 flex justify-end">
                    <button onclick="saveSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold transition-all">Apply Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const API_URL = "https://openrouter.ai/api/v1/chat/completions";
        const SYSTEM_PROMPT = `You are an expert web developer specializing in single-page HTML applications. 
Your goal is to build fully functional, beautiful apps based on user requests.
CRITICAL RULES:
1. Output ONLY a single HTML file.
2. Use Tailwind CSS via CDN: <script src="https://cdn.tailwindcss.com"><\/script>.
3. Include all JavaScript and CSS within the same file.
4. Ensure the app is responsive and modern.
5. If iterative changes are requested, provide the ENTIRE updated HTML file.
6. Surround your code with triple backticks like this: \`\`\`html [code] \`\`\`.
7. Do not explain anything, just output the markdown code block.`;

        // --- STATE ---
        let state = {
            apiKey: localStorage.getItem('architect_key') || '',
            model: localStorage.getItem('architect_model') || 'google/gemini-2.0-flash-exp:free',
            history: [], // Stores full HTML versions
            currentIndex: -1,
            isThinking: false,
            messages: []
        };

        // --- DOM ELEMENTS ---
        const els = {
            prompt: document.getElementById('prompt-input'),
            form: document.getElementById('chat-form'),
            messages: document.getElementById('messages'),
            preview: document.getElementById('preview-frame'),
            code: document.getElementById('code-editor'),
            settings: document.getElementById('settings-modal'),
            apiKeyInput: document.getElementById('api-key'),
            modelSelect: document.getElementById('model-select'),
            thinking: document.getElementById('thinking-state'),
            versionLabel: document.getElementById('version-label'),
            prevBtn: document.getElementById('prev-btn'),
            nextBtn: document.getElementById('next-btn')
        };

        // --- INIT ---
        window.onload = () => {
            els.apiKeyInput.value = state.apiKey;
            els.modelSelect.value = state.model;
            document.getElementById('model-badge').innerText = state.model.split('/')[1];
            
            // Auto-resize textarea
            els.prompt.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });

            // Prevent empty load blanking
            setTimeout(() => document.getElementById('app-loader').style.opacity = '0', 800);
            setTimeout(() => document.getElementById('app-loader').style.display = 'none', 1300);
        };

        // --- CORE FUNCTIONS ---
        async function handleSubmit(e) {
            e.preventDefault();
            const prompt = els.prompt.value.trim();
            if (!prompt || state.isThinking) return;

            if (!state.apiKey) {
                alert("Please add your OpenRouter API Key in settings.");
                toggleSettings();
                return;
            }

            // Update UI
            state.isThinking = true;
            els.thinking.classList.remove('hidden');
            addChatMessage('user', prompt);
            els.prompt.value = '';
            els.prompt.style.height = 'auto';

            // Build payload
            const userMessage = { role: 'user', content: prompt };
            state.messages.push(userMessage);

            const payload = {
                model: state.model,
                messages: [
                    { role: 'system', content: SYSTEM_PROMPT },
                    ...state.messages.slice(-5) // Send last 5 turns for context
                ],
                stream: true
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${state.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error("API Connection Failed");

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = "";
                
                // Add Assistant Bubble
                const assistantBubble = addChatMessage('assistant', 'Generating app...');

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataStr = line.slice(6);
                            if (dataStr === '[DONE]') break;
                            try {
                                const data = JSON.parse(dataStr);
                                const content = data.choices[0]?.delta?.content || "";
                                fullResponse += content;
                            } catch (e) {}
                        }
                    }
                }

                // Process result
                state.messages.push({ role: 'assistant', content: fullResponse });
                extractAndRender(fullResponse);
                assistantBubble.innerText = "App Updated Successfully.";

            } catch (err) {
                addChatMessage('assistant', "Error: " + err.message);
            } finally {
                state.isThinking = false;
                els.thinking.classList.add('hidden');
            }
        }

        function extractAndRender(text) {
            // Regex to grab content between ```html and ```
            const regex = /```html\s*([\s\S]*?)\s*```/;
            const match = text.match(regex);
            const code = match ? match[1].trim() : "";

            if (code) {
                updateVersionHistory(code);
                renderApp(code);
            }
        }

        function renderApp(html) {
            els.code.value = html;
            
            // Inject Tailwind if not present
            let finalHtml = html;
            if (!html.includes('tailwindcss')) {
                finalHtml = html.replace('</head>', '<script src="https://cdn.tailwindcss.com"><\/script></head>');
            }

            // Use srcdoc for sandboxed iframe
            els.preview.srcdoc = finalHtml;
        }

        // --- HISTORY MANAGEMENT ---
        function updateVersionHistory(code) {
            state.history.push(code);
            state.currentIndex = state.history.length - 1;
            updateHistoryUI();
        }

        function updateHistoryUI() {
            els.versionLabel.innerText = `V${state.currentIndex + 1}`;
            els.prevBtn.disabled = state.currentIndex <= 0;
            els.nextBtn.disabled = state.currentIndex >= state.history.length - 1;
        }

        function navigateHistory(direction) {
            const newIndex = state.currentIndex + direction;
            if (newIndex >= 0 && newIndex < state.history.length) {
                state.currentIndex = newIndex;
                renderApp(state.history[state.currentIndex]);
                updateHistoryUI();
            }
        }

        // --- UI UTILS ---
        function addChatMessage(role, text) {
            const div = document.createElement('div');
            div.className = `p-3 rounded-lg text-sm ${role === 'user' ? 'bg-white/5 ml-8 border border-white/5' : 'bg-blue-600/10 mr-8 border border-blue-500/20 text-blue-100'}`;
            div.innerText = text;
            els.messages.appendChild(div);
            els.messages.scrollTop = els.messages.scrollHeight;
            return div;
        }

        function toggleSettings() {
            els.settings.classList.toggle('hidden');
        }

        function saveSettings() {
            state.apiKey = els.apiKeyInput.value.trim();
            state.model = els.modelSelect.value;
            localStorage.setItem('architect_key', state.apiKey);
            localStorage.setItem('architect_model', state.model);
            document.getElementById('model-badge').innerText = state.model.split('/')[1];
            toggleSettings();
        }

        function switchTab(tab) {
            document.querySelectorAll('.view-panel').forEach(p => p.classList.remove('active', 'lg:flex'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('tab-active'));
            
            document.getElementById(`panel-${tab}`).classList.add('active');
            if (tab === 'preview') document.getElementById(`panel-${tab}`).classList.add('lg:flex');
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
        }

        function copyCode() {
            els.code.select();
            document.execCommand('copy');
            alert('Code copied to clipboard!');
        }

        function downloadCode() {
            if (!els.code.value) return;
            const blob = new Blob([els.code.value], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `app-v${state.currentIndex + 1}.html`;
            a.click();
        }

        els.form.onsubmit = handleSubmit;
    </script>
</body>
</html>
